---
// src/pages/[page].astro
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths({ paginate }) {
  const posts = (await getCollection('blog'))
    .filter(post => post.data.type !== 'news' && post.data.type !== 'feature')
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  return paginate(posts, { pageSize: 15 });
}

const { page } = Astro.props;
const title = page.currentPage === 1 ? "Home" : `Articles - Page ${page.currentPage}`;

// 検索機能用の全記事データ抽出
const allPostsForSearch = (await getCollection('blog'))
  .filter(post => post.data.type !== 'feature')
  .map(post => ({
    id: post.id,
    title: post.data.title,
    description: post.data.description || '',
    category: post.data.category || 'Uncategorized',
    type: post.data.type || 'article',
    tags: post.data.tags || [], 
    pubDateStr: post.data.pubDate.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/'),
    heroImage: post.data.heroImage || "https://placehold.co/600x400?text=No+Image"
  }));
---

<Layout title={title} description="AI Strategic Insight - 既存の記事を高品質な動画資産へ変換するArticle-to-Video戦略の実践メディア">
	
	{page.currentPage === 1 && (
		<section class="hero-section">
			<div class="hero-text-area">
				<div class="hero-text-content" id="heroTextContent">
                    <div class="hero-text-left">
					    <h1>Article-to-Video <br><span class="accent">Strategic Engineering</span></h1>
					    <p>既存のテキスト資産を、AIと戦略的設計で「売れる動画」へ。<br>SaaS/IT、HR、L&Dに特化した動画変換ソリューションの実践ログ。</p>
                    </div>

                    <div class="hero-text-right">
                        <a href="/blog/features/2026-02-28-article-to-video-future/" class="tech-focus-card">
                            <span class="tech-label">Technical Focus</span>
                            <p class="tech-title">生成AIの「幻覚」を制御する<br>最新RAGアーキテクチャ解説</p>
                            <span class="tech-arrow">View Article →</span>
                        </a>
                    </div>
				</div>
			</div>

			<div class="slider-section-bg">
				<div class="slider-wrapper" id="sliderViewport">
					<div class="slider-track" id="sliderTrack">
						<div class="slider-item"><div class="video-box">Demo 3 (L&D)</div></div>
						<div class="slider-item"><div class="video-box">Demo 4 (CS)</div></div>
						<div class="slider-item"><div class="video-box">Demo 1 (SaaS/IT)</div></div>
						<div class="slider-item"><div class="video-box">Demo 2 (HR)</div></div>
						<div class="slider-item"><div class="video-box">Demo 3 (L&D)</div></div>
						<div class="slider-item"><div class="video-box">Demo 4 (CS)</div></div>
						<div class="slider-item"><div class="video-box">Demo 1 (SaaS/IT)</div></div>
						<div class="slider-item"><div class="video-box">Demo 2 (HR)</div></div>
					</div>
				</div>
				
				<div class="slider-dots">
					<button class="dot active" data-index="0" aria-label="Slide 1"></button>
					<button class="dot" data-index="1" aria-label="Slide 2"></button>
					<button class="dot" data-index="2" aria-label="Slide 3"></button>
					<button class="dot" data-index="3" aria-label="Slide 4"></button>
				</div>
			</div>
		</section>
	)}

    <main class="main-container">
        <div id="searchData" data-posts={JSON.stringify(allPostsForSearch)} style="display: none;"></div>

        <div class="search-layout-wrapper">
            <div class="search-container">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="searchInput" placeholder="記事を検索 (キーワードを入力...)" autocomplete="off" />
            </div>
        </div>

        <div class="layout-grid">
            <div class="main-content-area">
                <div id="searchResultsBoard" class="main-board" style="display: none;">
                    <section class="archive-header">
                        <h2 class="section-title">Search Results</h2>
                    </section>
                    <div id="searchResults" class="post-list"></div>
                </div>

                <div class="main-board" id="defaultContents">
                    <section class="archive-header">
                        {page.currentPage === 1 ? (
                            <h2 class="section-title">Latest Articles <span class="feature-sub">- 最新記事 -</span></h2>
                        ) : (
                            <div class="page-header-box">
                                <h1 class="archive-title">Articles</h1>
                                <p class="article-count">
                                    {page.start + 1}〜{page.end + 1} / {page.total}件
                                </p>
                            </div>
                        )}
                    </section>
                    
                    <div class="post-list">
                        {page.data.map((post) => (
                            <a href={`/blog/${post.id.replace(/\.mdx?$/, '')}/`} class="post-card">
                                <div class="image-wrapper">
                                    <img src={post.data.heroImage || "https://placehold.co/600x400?text=No+Image"} alt="" />
                                </div>
                                <div class="post-content">
                                    <div class="post-meta">
                                        <span class="category">
                                            {post.data.category.toLowerCase().includes('saas') ? 'SaaS/IT' : post.data.category}
                                        </span>
                                        <time datetime={post.data.pubDate.toISOString()}>
                                            {post.data.pubDate.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/')}
                                        </time>
                                    </div>
                                    <h3 class="post-title">{post.data.title}</h3>
                                    <p class="post-description">{post.data.description}</p>
                                </div>
                            </a>
                        ))}
                    </div>

                    {page.lastPage > 1 && (
                        <nav class="pagination">
                            {page.url.prev && <a href={page.url.prev === "/1" ? "/" : page.url.prev} class="page-arrow">&lt;</a>}
                            {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((num) => (
                                <a href={num === 1 ? "/" : `/${num}/`} class={`page-number ${page.currentPage === num ? 'active' : ''}`}>{num}</a>
                            ))}
                            {page.url.next && <a href={page.url.next} class="page-arrow">&gt;</a>}
                        </nav>
                    )}
                </div>

                {page.currentPage === 1 && (
                    <section class="feature-section">
                        <div class="archive-header">
                            <h2 class="section-title">Feature <span class="feature-sub">- 特集記事 -</span></h2>
                        </div>
                        <div class="feature-grid">
                            <a href="/blog/features/2026-02-28-article-to-video-future/" class="feature-banner">
                                <img src="/blog/features/article-to-video-future.png" alt="【2026年】BtoB企業の記事が動き始める" />
                                <div class="feature-overlay">
                                    <span class="feature-date">2026/02/28</span>
                                    <h3 class="feature-title-text">【2026年】BtoBの記事が"動き始める"</h3>
                                </div>
                            </a>
                            <a href="#" class="feature-banner">
                                <img src="https://placehold.co/800x450/0984e3/ffffff?text=Feature+2" alt="特集2" />
                                <div class="feature-overlay">
                                    <span class="feature-tag">Technical Case</span>
                                    <h3 class="feature-title-text">SaaS企業が陥る「動画活用の罠」</h3>
                                </div>
                            </a>
                        <div class="feature-footer">
                            <a href="/features/1/" class="feature-all-btn">すべての特集記事を見る ＞</a>
                        </div>
                    </section>
                )}
            </div>

            <Sidebar />
        </div>
    </main>
</Layout>

<style is:global>
	.hero-section { display: block; background: #1e293b; overflow: hidden; }
	.hero-text-area { background: #1e293b; color: #fff; padding: 60px 0 40px; }
	
    .hero-text-content { 
        width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; box-sizing: border-box; 
        display: flex; justify-content: space-between; align-items: flex-end; 
        gap: 40px;
    }
    .hero-text-left { flex: 1; }
    .hero-text-area h1 { font-size: 2.8rem; line-height: 1.2; margin: 0 0 20px 0; font-weight: 900; }
	.hero-text-area .accent { color: #0284c7; }
	.hero-text-area p { font-size: 1.1rem; opacity: 0.9; margin: 0; line-height: 1.8; color: #cbd5e1; }

    .hero-text-right { flex: 0 0 340px; }
    .tech-focus-card {
        display: block; width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 24px;
        text-decoration: none; color: #fff; transition: all 0.2s; backdrop-filter: blur(8px);
    }
    .tech-focus-card:hover { background: rgba(255,255,255,0.1); border-color: #0284c7; transform: translateY(-3px); }
    .tech-label { display: inline-block; font-size: 0.75rem; font-weight: 800; color: #0284c7; letter-spacing: 0.1em; margin-bottom: 12px; text-transform: uppercase; border-bottom: 2px solid #0284c7; padding-bottom: 4px; }
    .tech-title { font-size: 1.1rem; font-weight: 800; line-height: 1.5; margin: 0 0 12px 0; color: #f8fafc; }
    .tech-arrow { font-size: 0.85rem; color: #94a3b8; display: block; text-align: right; font-weight: 700; }

    .slider-section-bg { width: 100%; background: #0f172a; padding: 40px 0 60px; border-top: 1px solid #1e293b; }
	.slider-wrapper { width: 100%; position: relative; overflow: hidden; }
	.slider-track { display: flex; gap: 40px; width: max-content; transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1); }
	.slider-item { width: 560px; flex-shrink: 0; }
	.video-box { width: 100%; aspect-ratio: 16 / 9; background: #1e293b; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 900; color: #ffffff; border: 2px solid #334155; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
	.slider-dots { display: flex; justify-content: center; gap: 12px; margin-top: 40px; width: 100%; }
	.dot { width: 24px; height: 6px; border-radius: 3px; background: #334155; border: none; cursor: pointer; transition: all 0.3s; padding: 0; }
	.dot.active { background: #0284c7; width: 48px; }

    .main-container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    .layout-grid { display: grid; grid-template-columns: 1fr 320px; gap: 40px; }
    .main-content-area { min-width: 0; }

	.main-board { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
	.archive-header { margin-bottom: 32px; border-bottom: 4px solid #1e293b; padding-bottom: 12px; }
	.section-title { font-size: 1.8rem; font-weight: 900; color: #1e293b; margin: 0; display: flex; align-items: baseline; letter-spacing: -0.02em; }
    .feature-sub { font-size: 0.9rem; margin-left: 12px; color: #64748b; font-weight: 700; }
	
    .post-list { display: flex; flex-direction: column; gap: 32px; margin-bottom: 32px; }
	.post-card { text-decoration: none; color: inherit; display: flex; gap: 24px; border-bottom: 1px solid #f1f5f9; padding-bottom: 32px; transition: all 0.2s; }
    .post-card:hover { transform: translateX(5px); }
    .post-card:hover .post-title { color: #0284c7; }

	.image-wrapper { flex: 0 0 240px; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; background: #f1f5f9; }
    .image-wrapper img { width: 100%; height: 100%; object-fit: cover; }
	
    .post-content { flex: 1; min-width: 0; }
    .post-meta { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
	.category { background: #1e293b; color: #fff; font-size: 0.7rem; font-weight: 800; padding: 4px 10px; border-radius: 4px; text-transform: uppercase; }
    time { color: #64748b; font-size: 0.85rem; font-weight: 600; }
	.post-title { font-size: 1.25rem; margin: 0 0 10px 0; color: #0f172a; font-weight: 800; line-height: 1.4; }
    .post-description { font-size: 0.95rem; color: #475569; margin: 0; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

	.pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 40px; }
    .page-number, .page-arrow { display: flex; justify-content: center; align-items: center; width: 44px; height: 44px; border: 2px solid #e2e8f0; border-radius: 12px; text-decoration: none; color: #1e293b; font-weight: 800; transition: all 0.2s; }
    .page-number.active { background: #1e293b; color: #fff; border-color: #1e293b; }
    .page-number:hover:not(.active) { border-color: #0284c7; color: #0284c7; }

    .feature-section { margin-top: 64px; }
    .feature-footer { margin-top: 40px; text-align: center; }
    .feature-all-btn { 
        display: inline-block;
        padding: 12px 32px;
        background: #f1f5f9;
        color: #475569;
        text-decoration: none;
        font-weight: 800;
        font-size: 0.95rem;
        border-radius: 12px;
        transition: all 0.2s;
    }
    .feature-all-btn:hover { background: #1e293b; color: #fff; }
    .feature-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
    .feature-banner { position: relative; border-radius: 20px; overflow: hidden; aspect-ratio: 16/9; display: block; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .feature-banner img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
    .feature-banner:hover img { transform: scale(1.05); }
    .feature-overlay { 
        position: absolute; 
        inset: 0; 
        padding: 40px; 
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: flex-start; /* Left-aligned horizontally */
        text-align: left;        /* Left-aligned text */
        background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.7)); 
        color: #fff; 
    }
    .feature-date, .feature-tag { 
        position: absolute;
        top: 24px;
        left: 24px;
        font-size: 0.85rem; 
        font-weight: 800; 
        color: #ffffff; /* White for better visibility */
        margin: 0; 
        background: none; 
        padding: 0; 
        border-radius: 0; 
        width: max-content; 
        text-transform: uppercase;
        letter-spacing: 0.05em;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .feature-title-text { 
        font-size: 1.6rem; 
        font-weight: 900; 
        line-height: 1.4; 
        margin: 0; 
        text-shadow: 0 4px 12px rgba(0,0,0,0.5); 
        max-width: 90%;
        /* 2-line truncation (ellipsis) */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .search-layout-wrapper { margin-bottom: 40px; }
    .search-container { position: relative; width: 100%; }
    .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 22px; height: 22px; color: #94a3b8; pointer-events: none; }
    #searchInput { width: 100%; padding: 16px 20px 16px 54px; font-size: 1.1rem; border: 2px solid #e2e8f0; border-radius: 16px; background-color: #ffffff; color: #1e293b; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transition: all 0.3s; box-sizing: border-box; }
    #searchInput:focus { outline: none; border-color: #0284c7; box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1); }

	@media (max-width: 1024px) {
        .layout-grid { grid-template-columns: 1fr; }
        .hero-text-content { flex-direction: column; align-items: flex-start; }
        .hero-text-right { width: 100%; }
        .slider-item { width: 440px; }
    }
</style>

<script>
	const viewport = document.getElementById('sliderViewport');
	const track = document.getElementById('sliderTrack');
	const items = document.querySelectorAll('.slider-item');
	const dots = document.querySelectorAll('.dot');
    const heroText = document.getElementById('heroTextContent');

	if (viewport && track && items.length > 0 && heroText) {
		let currentIndex = 0;
		function updateSlider(index) {
			const itemWidth = items[0].getBoundingClientRect().width;
			const gap = 40;
            const heroRect = heroText.getBoundingClientRect();
            const leftOffset = heroRect.left + 20; 
			const scrollAmount = (itemWidth + gap) * (index + 2); 
			track.style.transform = `translateX(${leftOffset - scrollAmount}px)`;
			dots.forEach(dot => dot.classList.remove('active'));
			if(dots[index]) dots[index].classList.add('active');
		}
		dots.forEach(dot => {
			dot.addEventListener('click', (e) => {
                const indexStr = (e.target as HTMLElement).dataset.index;
                if (indexStr) {
                    currentIndex = parseInt(indexStr);
				    updateSlider(currentIndex);
                }
			});
		});
		window.addEventListener('resize', () => { updateSlider(currentIndex); });
		setTimeout(() => { updateSlider(currentIndex); }, 100);

		// Auto slide every 5 seconds
		setInterval(() => {
			currentIndex = (currentIndex + 1) % dots.length;
			updateSlider(currentIndex);
		}, 5000);
	}
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        const searchResultsBoard = document.getElementById('searchResultsBoard');
        const searchResults = document.getElementById('searchResults');
        const defaultContents = document.getElementById('defaultContents');
        const searchDataEl = document.getElementById('searchData');

        if (searchInput && searchResultsBoard && searchResults && defaultContents && searchDataEl) {
            let allPostsForSearch = [];
            try {
                allPostsForSearch = JSON.parse(searchDataEl.dataset.posts || '[]');
            } catch (e) { console.error('Error loading search data', e); }

            searchInput.addEventListener('input', (e) => {
                const keyword = (e.target as HTMLInputElement).value.toLowerCase().trim();
                if (keyword === '') {
                    searchResultsBoard.style.display = 'none';
                    searchResults.innerHTML = '';
                    defaultContents.style.display = 'block';
                    return;
                }
                const hits = allPostsForSearch.filter(post => 
                    post.title.toLowerCase().includes(keyword) || 
                    post.description.toLowerCase().includes(keyword) ||
                    post.tags.some(tag => tag.toLowerCase().includes(keyword))
                );
                defaultContents.style.display = 'none';
                searchResultsBoard.style.display = 'block';
                if (hits.length === 0) {
                    searchResults.innerHTML = '<div class="no-results">該当する記事が見つかりませんでした。</div>';
                    return;
                }
                searchResults.innerHTML = hits.map(post => `
                    <a href="/blog/${post.id.replace(/\.mdx?$/, '')}/" class="post-card">
                        <div class="image-wrapper"><img src="${post.heroImage}" alt="" /></div>
                        <div class="post-content">
                            <div class="post-meta"><span class="category">${post.category}</span><time>${post.pubDateStr}</time></div>
                            <h3 class="post-title">${post.title}</h3>
                            <p class="post-description">${post.description}</p>
                        </div>
                    </a>
                `).join('');
            });
        }
    });
</script>
