---
// src/pages/blog/[id].astro 等
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { id: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

// --- 関連記事のロジック ---
const allPosts = await getCollection('blog');
const currentTags = post.data.tags || [];

const relatedPosts = allPosts
  .filter((p) => {
    const isSamePost = p.id === post.id;
    const isNews = p.data.type === 'news';
    if (isSamePost || isNews) return false;

    // タグが一つでも一致するか確認
    const hasCommonTag = p.data.tags?.some(tag => currentTags.includes(tag));
    // あるいはカテゴリーが同じか確認
    const isSameCategory = p.data.category === post.data.category;

    return hasCommonTag || isSameCategory;
  })
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3); // 3件程度がすっきりします
---

<Layout title={post.data.title} description={post.data.description}>
  <article class="post-main">
    <Content />
  </article>

  {/* 関連記事セクション：220533.jpg の構造をベースに独自デザイン化 */}
  {relatedPosts.length > 0 && (
    <section class="related-articles">
      <h2 class="related-section-title">関連記事</h2>
      <div class="related-list">
        {relatedPosts.map((related) => (
          <a href={`/blog/${related.id}/`} class="related-item">
            <div class="related-thumb">
              <img src={related.data.heroImage || "https://placehold.co/400x225/eee/666?text=No+Image"} alt="" />
            </div>
            <div class="related-body">
              <h3 class="related-title">{related.data.title}</h3>
              <div class="related-meta">
                <span class="related-cat">
                  {related.data.category.toLowerCase().includes('saas') ? 'SaaS/IT' : related.data.category}
                </span>
                <time>{related.data.pubDate.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/')}</time>
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}
</Layout>

<style>
  /* 関連記事のスタイル（パクリに見えないよう現在のサイトのトーンに合わせる） */
  .related-articles {
    margin-top: 80px;
    padding-top: 40px;
    border-top: 2px solid #eee;
  }
  .related-section-title {
    font-size: 1.4rem;
    font-weight: bold;
    color: #1e272e;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .related-section-title::before {
    content: '';
    width: 5px;
    height: 1.4rem;
    background: #1e272e; /* サイトのメインカラー */
    border-radius: 2px;
  }

  .related-list {
    display: flex;
    flex-direction: column;
    gap: 0; /* 境界線を引くため */
  }

  .related-item {
    display: flex;
    gap: 20px;
    padding: 20px 0;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid #f1f1f1;
    transition: background-color 0.2s;
  }
  .related-item:last-child { border-bottom: none; }
  .related-item:hover { background-color: #fafafa; }
  .related-item:hover .related-title { color: #0984e3; text-decoration: underline; }

  .related-thumb {
    flex: 0 0 160px; /* サムネイルを少し小さめに */
    aspect-ratio: 16 / 9;
    border-radius: 4px;
    overflow: hidden;
    background: #f8f9fa;
  }
  .related-thumb img { width: 100%; height: 100%; object-fit: cover; }

  .related-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0;
  }
  .related-title {
    font-size: 1.05rem;
    font-weight: bold;
    line-height: 1.5;
    margin: 0 0 10px 0;
    color: #1e272e;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .related-meta {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .related-cat {
    font-size: 0.65rem;
    font-weight: bold;
    color: #64748b;
    border: 1px solid #e2e8f0;
    padding: 1px 6px;
    border-radius: 3px;
  }
  .related-meta time {
    font-size: 0.75rem;
    color: #94a3b8;
  }

  @media (max-width: 640px) {
    .related-item { gap: 12px; }
    .related-thumb { flex: 0 0 100px; }
    .related-title { font-size: 0.95rem; }
  }
</style>